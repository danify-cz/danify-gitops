apiVersion: v1
kind: ConfigMap
metadata:
  name: argocd-notifications-cm
  namespace: argocd
data:
  service.webhook.discord: |
    url: $discord-webhook-url
    headers:
    - name: Content-Type
      value: application/json

  template.app-sync-running: |
    webhook:
      discord:
        method: POST
        body: |
          {"content":"üîÑ **{{.app.metadata.name}}** sync started","embeds":[{"color":3447003,"fields":[{"name":"App","value":"{{.app.metadata.name}}","inline":true},{"name":"Namespace","value":"{{.app.spec.destination.namespace}}","inline":true},{"name":"Revision","value":"{{.app.status.sync.revision | substr 0 7}}","inline":true}]}]}

  template.app-deployed: |
    webhook:
      discord:
        method: POST
        body: |
          {"content":"‚úÖ **{{.app.metadata.name}}** deployed","embeds":[{"color":3066993,"fields":[{"name":"App","value":"{{.app.metadata.name}}","inline":true},{"name":"Namespace","value":"{{.app.spec.destination.namespace}}","inline":true},{"name":"Revision","value":"{{.app.status.sync.revision | substr 0 7}}","inline":true}{{range .app.status.summary.images}},{"name":"Image","value":"{{.}}","inline":false}{{end}}]}]}

  template.app-sync-failed: |
    webhook:
      discord:
        method: POST
        body: |
          {"content":"‚ùå **{{.app.metadata.name}}** sync failed","embeds":[{"color":15158332,"fields":[{"name":"App","value":"{{.app.metadata.name}}","inline":true},{"name":"Namespace","value":"{{.app.spec.destination.namespace}}","inline":true}]}]}

  template.app-health-degraded: |
    webhook:
      discord:
        method: POST
        body: |
          {"content":"‚ö†Ô∏è **{{.app.metadata.name}}** health degraded","embeds":[{"color":16776960,"fields":[{"name":"App","value":"{{.app.metadata.name}}","inline":true},{"name":"Namespace","value":"{{.app.spec.destination.namespace}}","inline":true},{"name":"Health","value":"{{.app.status.health.status}}","inline":true}]}]}

  trigger.on-sync-running: |
    - when: app.status.operationState.phase in ['Running']
      send: [app-sync-running]

  trigger.on-deployed: |
    - when: app.status.operationState.phase in ['Succeeded']
      send: [app-deployed]

  trigger.on-sync-failed: |
    - when: app.status.operationState.phase in ['Error', 'Failed']
      send: [app-sync-failed]

  trigger.on-health-degraded: |
    - when: app.status.health.status == 'Degraded'
      send: [app-health-degraded]

  # Global subscriptions - all apps get notifications
  subscriptions: |
    - recipients:
      - discord
      triggers:
      - on-sync-running
      - on-deployed
      - on-sync-failed
      - on-health-degraded
